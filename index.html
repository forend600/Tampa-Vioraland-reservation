<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ù…Ù†ØªØ¬Ø¹Ø§Øª  Ø§Ù„ Ø¯ÙˆØ§Ø³ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#2980b9">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    *, *::before, *::after { box-sizing: border-box; }
    :root { --brand-blue: #2980b9; --brand-green: #27ae60; --brand-red: #e74c3c; --brand-gold: #f1c40f; }
    
    body { font-family: 'Times New Roman', Arial, Tahoma, sans-serif; direction: rtl; margin: 0; padding: 0; background: #fdf5e6; text-align: right; }

    /* Login UI */
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
    #loginOverlay input { width: 220px; text-align: center; font-size: 20px; padding: 10px; border-radius: 8px; border: none; margin: 20px; }

    /* Tabs */
    .tab-nav { display: flex; background: var(--brand-blue); position: sticky; top: 0; z-index: 1000; }
    .tab-nav button { flex: 1; padding: 15px; border: none; background: none; color: white; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; font-size: 14px; }
    .tab-nav button.active { border-bottom: 3px solid #fff; background: rgba(255,255,255,0.1); }
    .tab-content { display: none; padding: 10px; }
    .tab-content.active { display: block; }

    .container { max-width: 800px; margin: 10px auto; padding: 20px; background: #fff; border-radius: 14px; border: 3px solid var(--brand-blue); }
    h1 { text-align: center; color: #2c3e50; font-size: 22px; margin-bottom: 5px; }
    .title-underline { width: 80px; height: 3px; background: var(--brand-blue); margin: 0 auto 15px; }
    
    form, .card { max-width: 520px; margin: 10px auto; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.07); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; text-align: right; font-size: 16px; }

    .options-row { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 8px; margin-top: 12px; }
    .option-block { display: flex; align-items: center; gap: 5px; font-size: 14px; }
    .option-block input { width: auto; margin: 0; }

    /* Search & Filter UI */
    .filter-box { display: flex; gap: 10px; margin: 10px 0; }
    .filter-box input, .filter-box select { margin-top: 0; padding: 8px; font-size: 14px; }

    .btn-primary { background: var(--brand-green); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; margin-top: 15px; font-weight: bold; font-size: 16px; }
    
    .table-wrapper { width: 100%; overflow-x: auto; margin-top: 15px; border: 1px solid #eee; }
    /* ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
.table-wrapper { 
    width: 100%; 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
}

table { 
    width: 100%; 
    border-collapse: collapse; 
    background: white; 
    min-width: auto; /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ 500px Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
    table-layout: auto; /* Ø¬Ø¹Ù„ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ­Ø³Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
}

th, td { 
    border: 1px solid #eee; 
    padding: 10px 5px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø¹Ø±Ø¶ÙŠ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    text-align: center; 
    font-size: 13px; 
    white-space: nowrap; /* Ù…Ù†Ø¹ Ø§Ù†ÙƒØ³Ø§Ø± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø³Ø·Ø±ÙŠÙ† */
}

/* ØªÙˆØ³ÙŠØ¹ Ù‡ÙˆØ§Ù…Ø´ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµØ§ÙÙŠ (Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø§Ø±) */
th:last-child, td:last-child {
    padding-left: 25px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© */
    padding-right: 15px;
    border-right: 2px solid #ddd; /* ØªÙ…ÙŠÙŠØ² Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ· Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµØ§ÙÙŠ */
}
    th { background: #f8f9fa; }
    
    .income { color: var(--brand-green); font-weight: bold; }
    .expense { color: var(--brand-red); font-weight: bold; }
    .text-green { color: var(--brand-green); font-weight: bold; }
    .text-red { color: var(--brand-red); font-weight: bold; }

    #contract { display: none; margin-top: 20px; }
    .booking-number { color: #e53935; font-weight: bold; font-size: 22px; text-align: center; margin: 10px 0; }
    .terms ul { padding-right: 20px; list-style-type: disc; text-align: right; }
    .contract-footer { text-align: center; font-size: 12px; color: #555; margin-top: 15px; }

    @media print { .tab-nav, .actions, form, .card, #loginOverlay { display: none !important; } .container { border: none; } }
</style>
</head>
<body>

<div id="loginOverlay">
    <h2>Ù…Ù†ØªØ¬Ø¹Ø§Øª Ø§Ù„ Ø¯ÙˆØ§Ø³</h2>
    <p>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¥Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ù‚ÙˆÙ‚Ù„</p>
    <div id="g_id_onload"
         data-client_id="809378312368-be35pci821otu0mdurik53imidefmvhj.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin_with" data-shape="rectangular" data-logo_alignment="left"></div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<nav class="tab-nav">
    <button class="active" onclick="openTab(event, 'reservationTab')">Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
    <button onclick="openTab(event, 'dailyTab')">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
    <button onclick="openTab(event, 'reportTab')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
</nav>

<div id="reservationTab" class="tab-content active">
    <h1>Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø±</h1>
    <div class="title-underline"></div>
    <form id="bookingForm">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø¹:</label>
        <select id="resortSelect">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø¹</option>
            <option value="Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§">Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§</option>
            <option value="Ù…Ù†ØªØ¬Ø¹ ÙÙŠÙˆØ±Ø§Ù„Ø§Ù†Ø¯">Ù…Ù†ØªØ¬Ø¹ ÙÙŠÙˆØ±Ø§Ù„Ø§Ù†Ø¯</option>
        </select>
        <div class="options-row"><div class="option-block"><input type="checkbox" id="bookBothResorts"><label>Ø­Ø¬Ø² Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ† Ù…Ø¹Ø§Ù‹</label></div></div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
        <input type="text" id="customerName" required>
        <label>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†:</label>
        <input type="number" id="deposit" required>
        <label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
        <input type="number" id="remaining" required>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
        <input type="date" id="bookingDate" required>
        <div class="options-row">
            <div class="option-block"><input type="checkbox" id="overnight"><label>Ù…Ø¨ÙŠØª</label></div>
            <div class="option-block"><input type="checkbox" id="noPool"><label>Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¨Ø­</label></div>
            <div class="option-block"><input type="checkbox" id="winterPeriod"><label>ÙØªØ±Ø© Ø§Ù„Ø´ØªÙˆÙŠØ©</label></div>
        </div>
        <div id="tampaOptions" style="display:none; flex-direction: row; align-items: center; justify-content: flex-end; gap: 15px;" class="options-row">
    <span style="font-weight:bold;">Ø®Ø§Øµ Ø¨ØªØ§Ù…Ø¨Ø§:</span>
    <div class="option-block" style="display:flex; align-items:center; gap:5px;">
        <input type="checkbox" id="summer"><label for="summer">ØµÙŠÙ</label>
    </div>
    <div class="option-block" style="display:flex; align-items:center; gap:5px;">
        <input type="checkbox" id="winter"><label for="winter">Ø´ØªØ§Ø¡</label>
    </div>
</div>
        <button type="submit" class="btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯</button>
    </form>

    <div id="contract" class="container">
        <h1 id="contractTitle"></h1>
        <div id="bookingNumber" class="booking-number"></div>
        <div id="introText"></div>
        <div id="bookingDetails"></div>
        <hr>
        <div class="terms">
            <h3>Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…:</h3>
            <ul id="termsList"></ul>
            <p style="text-align:center"><strong>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø±Ø¯ Ø¨ÙƒÙ„Ù…Ø© Ù…ÙˆØ§ÙÙ‚</strong></p>
        </div>
        <div id="contractFooter" class="contract-footer"></div>
        <div class="actions" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button id="saveAllBtn" class="btn-primary" style="background:var(--brand-green)">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ + Ø­ÙØ¸ Ù…Ø§Ù„ÙŠØ©</button>
            <button id="calendarICSBtn" class="btn-primary" style="background:var(--brand-blue)">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙ‚ÙˆÙŠÙ… + Ø­ÙØ¸ Ù…Ø§Ù„ÙŠØ©</button>
        </div>
    </div>
</div>

<div id="dailyTab" class="tab-content">
    <h1>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
    <div class="card">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</h3>
        <input type="hidden" id="editId">
        <input type="date" id="transDate">
        <select id="transType">
            <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø± (Ø¯Ø®Ù„)</option>
            <option value="Ù…ØµØ±ÙˆÙØ§Øª">Ù…ØµØ±ÙˆÙØ§Øª</option>
            <option value="Ø¬Ù…Ø¹ÙŠØ©">Ø¬Ù…Ø¹ÙŠØ© / Ù‚Ø±ÙˆØ¶</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input type="number" id="transAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="transDesc" placeholder="Ø§Ù„ÙˆØµÙ (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ)">
        <button onclick="saveTransaction()" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>

    <div class="card">
        <div class="filter-box">
            <input type="text" id="searchQuery" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." oninput="renderDailyTable()">
            <select id="filterType" onchange="renderDailyTable()">
                <option value="Ø§Ù„ÙƒÙ„">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
                <option value="Ù…ØµØ±ÙˆÙØ§Øª">Ù…ØµØ±ÙˆÙØ§Øª</option>
                <option value="Ø¬Ù…Ø¹ÙŠØ©">Ø¬Ù…Ø¹ÙŠØ© / Ù‚Ø±ÙˆØ¶</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="dailyTable">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="dailyTableBody"></tbody>
        </table>
    </div>
</div>

<div id="reportTab" class="tab-content">
    <h1 id="reportMainTitle">Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø©</h1>
    <div class="title-underline"></div>
    
    <div class="card" style="max-width: 200px; margin-bottom: 20px;">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
        <select id="yearFilter" onchange="renderReportTable()">
            </select>
    </div>

    <div class="table-wrapper">
        <table id="reportTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø´Ù‡Ø±</th>
                    <th>Ø§Ù„Ø¯Ø®Ù„ (+)</th>
                    <th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (-)</th>
                    <th>Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© (-)</th>
                    <th>Ø£Ø®Ø±Ù‰ (-)</th>
                    <th>Ø§Ù„ØµØ§ÙÙŠ</th>
                </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
        </table>
    </div>
    
    <div class="actions" style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="exportToExcel()" class="btn-primary" style="background:#1d6f42">ØªØµØ¯ÙŠØ± Excel</button>
        <button onclick="exportToImage()" class="btn-primary" style="background:#c0392b">ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© / PDF</button>
    </div>
</div>

<script>
let currentPIN = "";
// Ø§Ø³ØªØ¨Ø¯Ø§Ù„ PIN Ø¨Ù…ØªØºÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
let currentUserEmail = localStorage.getItem('thalathat_user_session') || ""; 
let transactions = JSON.parse(localStorage.getItem('thalathat_v5_data')) || [];

// ÙˆØ¸ÙŠÙØ© ÙÙƒ ØªØ´ÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ù‚ÙˆÙ‚Ù„
function parseJwt(token) {
    let base64Url = token.split('.')[1];
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    let jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±Ø¯ Ù‚ÙˆÙ‚Ù„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function handleCredentialResponse(response) {
    const user = parseJwt(response.credential);
    currentUserEmail = user.email; // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† PIN
    
    // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    localStorage.setItem('thalathat_user_session', currentUserEmail);
    
    document.getElementById('loginOverlay').style.display = 'none';
    loadSystem();
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
async function loadSystem() {
    const savedUser = localStorage.getItem('thalathat_user_session');
    if (savedUser) {
        currentUserEmail = savedUser;
        document.getElementById('loginOverlay').style.display = 'none';
    } else {
        return; // ØªÙˆÙ‚Ù Ø­ØªÙ‰ ÙŠØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    }
    
    document.getElementById('transDate').valueAsDate = new Date();
    await pullFromCloud(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚ÙˆÙ‚Ù„ Ø´ÙŠØª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
    renderDailyTable();
    renderReportTable();
}

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBHoKhYr9U6uR58oBBLmQTsngIGu98gZtEFIiMqGL7wYtoiw6l2LjUqU4XE1XR4wnd/exec";

// ÙˆØ¸ÙŠÙØ© Ø¯ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨
async function pushToCloud() {
    if (!currentUserEmail) return; // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                userEmail: currentUserEmail, // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¯Ù‰ Ù‚ÙˆÙ‚Ù„ Ø´ÙŠØª
                data: transactions
            })
        });
        console.log("ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù„Ù„Ù…ÙˆØ¸Ù: " + currentUserEmail);
    } catch (e) { console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©"); }
}

async function pullFromCloud() {
    if (!currentUserEmail) return;
    try {
        // Ø¥Ø®Ø¨Ø§Ø± Ø§Ù„Ø³Ø­Ø§Ø¨ Ø¨Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ØªØ­Ø¯ÙŠØ¯Ø§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·
        const response = await fetch(`${SCRIPT_URL}?userEmail=${currentUserEmail}`);
        const cloudData = await response.json();
        if (cloudData && Array.isArray(cloudData)) {
            transactions = cloudData;
            localStorage.setItem('thalathat_v5_data', JSON.stringify(transactions));
            renderDailyTable();
            renderReportTable();
        }
    } catch (e) { console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù"); }
}

// ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨
async function pullFromCloud() {
    try {
        const response = await fetch(SCRIPT_URL);
        const cloudData = await response.json();
        if (cloudData && Array.isArray(cloudData)) {
            transactions = cloudData;
            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ø£ÙŠØ¶Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
            localStorage.setItem('thalathat_v5_data', JSON.stringify(transactions));
            renderDailyTable();
            renderReportTable();
        }
    } catch (e) { console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹"); }
}

// ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
function updateYearSelector() {
    const selector = document.getElementById('yearFilter');
    if (!selector) return;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© + Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© 2026 ÙƒØ®ÙŠØ§Ø± Ø£Ø³Ø§Ø³ÙŠ
    let years = transactions.map(t => new Date(t.date).getFullYear());
    years.push(new Date().getFullYear()); // Ø¥Ø¶Ø§ÙØ© 2026

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
    const uniqueYears = [...new Set(years)].sort((a, b) => b - a);
    
    // Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù„ØªØ¬Ù†Ø¨ Ø¶ÙŠØ§Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±)
    const currentSelected = selector.value || new Date().getFullYear().toString();

    selector.innerHTML = '';
    uniqueYears.forEach(year => {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        selector.appendChild(opt);
    });

    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ù„Ø³Ù†Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù…Ø®ØªØ§Ø±Ø© Ø£Ùˆ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    selector.value = currentSelected;
}

// ÙˆØ¸ÙŠÙØ© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ØµÙŠØºØ© Ù‚ÙˆÙ‚Ù„ (Ø³Ù†Ø© Ø´Ù‡Ø± ÙŠÙˆÙ… T Ø³Ø§Ø¹Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø«Ø§Ù†ÙŠØ©)
function formatDateTimeForGoogle(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const da = String(d.getDate()).padStart(2, '0');
    const h = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    return `${y}${m}${da}T${h}${min}00`;
}

function checkLogin() {
    currentPIN = document.getElementById('pinInput').value;
    if(!currentPIN) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²");
    document.getElementById('loginOverlay').style.display = 'none';
    loadSystem();
}

function saveSystem() {
    localStorage.setItem('thalathat_v5_data', JSON.stringify(transactions));
    renderDailyTable();
    renderReportTable();
    pushToCloud(); // Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚ÙˆÙ‚Ù„ Ø£ÙŠØ¶Ø§Ù‹
}

/* --- Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¨Ø­Ø« --- */
function renderDailyTable() {
    const tbody = document.getElementById('dailyTableBody');
    const query = document.getElementById('searchQuery').value.toLowerCase();
    const typeFilter = document.getElementById('filterType').value;
    tbody.innerHTML = '';
    
    transactions.filter(t => t.owner === currentPIN)
        .filter(t => (typeFilter === "Ø§Ù„ÙƒÙ„" || t.type === typeFilter))
        .filter(t => (t.desc.toLowerCase().includes(query) || t.type.toLowerCase().includes(query)))
        .sort((a,b) => new Date(b.date) - new Date(a.date))
        .forEach(t => {
            tbody.innerHTML += `<tr>
                <td>${t.date}</td>
                <td>${t.type}</td>
                <td>${t.desc}</td>
                <td class="${t.type === 'Ø¥ÙŠØ¬Ø§Ø±' ? 'income' : 'expense'}">${t.amount}</td>
                <td>
                    <span onclick="editTrans(${t.id})" style="cursor:pointer">âœï¸</span> 
                    <span onclick="deleteTrans(${t.id})" style="cursor:pointer">ğŸ—‘ï¸</span>
                </td>
            </tr>`;
        });
}

function recordFinance() {
    if(isCurrentSaved) return;
    const resort = document.getElementById('bookBothResorts').checked ? "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ†" : document.getElementById('resortSelect').value;
    const name = document.getElementById('customerName').value;
    const total = parseFloat(document.getElementById('deposit').value) + parseFloat(document.getElementById('remaining').value);
    const date = document.getElementById('bookingDate').value;
    
    transactions.push({ 
        id: Date.now(), 
        date, 
        type: 'Ø¥ÙŠØ¬Ø§Ø±', 
        amount: total, 
        desc: `Ø­Ø¬Ø² ${resort}: ${name}`, 
        owner: currentUserEmail // ØªØ®Ø²ÙŠÙ† Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø®ØµÙˆØµÙŠØ©
    });
    isCurrentSaved = true;
    saveSystem();
}

/* --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµÙ„Ø­Ø© --- */
function saveTransaction() {
    const editId = document.getElementById('editId').value;
    const date = document.getElementById('transDate').value;
    const type = document.getElementById('transType').value;
    const amount = parseFloat(document.getElementById('transAmount').value);
    const desc = document.getElementById('transDesc').value;

    if(!date || isNaN(amount)) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº");

    if (editId) {
        // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const index = transactions.findIndex(t => t.id == editId);
        if (index !== -1) {
            transactions[index] = { ...transactions[index], date, type, amount, desc };
        }
    } else {
        // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        transactions.push({ id: Date.now(), date, type, amount, desc, owner: currentPIN });
    }
    
    saveSystem();
    resetFinanceForm();
}

function editTrans(id) {
    const t = transactions.find(item => item.id == id);
    if(t) {
        document.getElementById('editId').value = t.id;
        document.getElementById('transDate').value = t.date;
        document.getElementById('transType').value = t.type;
        document.getElementById('transAmount').value = t.amount;
        document.getElementById('transDesc').value = t.desc;
        
        const saveBtn = document.querySelector("button[onclick='saveTransaction()']");
        saveBtn.textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
        saveBtn.style.background = "var(--brand-gold)";
    }
}

function resetFinanceForm() {
    document.getElementById('editId').value = "";
    document.getElementById('transAmount').value = "";
    document.getElementById('transDesc').value = "";
    document.getElementById('transDate').valueAsDate = new Date();
    const saveBtn = document.querySelector("button[onclick='saveTransaction()']");
    saveBtn.textContent = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
    saveBtn.style.background = "var(--brand-green)";
}

/* --- Ø¨Ø§Ù‚ÙŠ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„Ø´Ø±ÙˆØ· (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) --- */
const resortSelect = document.getElementById('resortSelect');
resortSelect.addEventListener('change', () => {
    document.getElementById('tampaOptions').style.display = (resortSelect.value === 'Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§' || document.getElementById('bookBothResorts').checked) ? 'flex' : 'none';
});

document.getElementById('bookingForm').onsubmit = (e) => {
    e.preventDefault();
    isCurrentSaved = false;
    showContract();
};

function showContract() {
    const isBoth = document.getElementById('bookBothResorts').checked;
    const resort = isBoth ? "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ† (ØªØ§Ù…Ø¨Ø§ ÙˆÙÙŠÙˆØ±Ø§Ù„Ø§Ù†Ø¯)" : resortSelect.value;
    const name = document.getElementById('customerName').value;
    const dep = document.getElementById('deposit').value;
    const rem = document.getElementById('remaining').value;
    const date = document.getElementById('bookingDate').value;
    const isOvernight = document.getElementById('overnight').checked;
    const isNoPool = document.getElementById('noPool').checked;
    const isWinter = document.getElementById('winter').checked;
    const isSummer = document.getElementById('summer').checked;

    let hours = "";
    if (document.getElementById('winterPeriod').checked) {
        hours = isOvernight ? "Ù…Ù† Ù¢ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¡Ù  ØµØ¨Ø§Ø­Ù‹Ø§" : "Ù…Ù† Ù¢ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¢ ØµØ¨Ø§Ø­Ù‹Ø§";
    } else {
        hours = isOvernight ? "Ù…Ù† Ù£ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¡Ù¡ ØµØ¨Ø§Ø­Ù‹Ø§" : "Ù…Ù† Ù£ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¦ ØµØ¨Ø§Ø­Ù‹Ø§";
    }

    const timeClass = (!isOvernight && !isNoPool) ? "text-green" : "text-red";
    const poolText = isNoPool ? "<span class='text-red'>Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¨Ø­</span>" : "<span class='text-green'>ÙŠØ´Ù…Ù„ Ù…Ø³Ø¨Ø­</span>";
    const overnightText = isOvernight ? "<span class='text-red'>ÙŠØ´Ù…Ù„ Ù…Ø¨ÙŠØª</span>" : "<span class='text-green'>Ø¨Ø¯ÙˆÙ† Ù…Ø¨ÙŠØª</span>";

    document.getElementById('contract').style.display = "block";
    document.getElementById('contractTitle').textContent = `Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø± ${resort}`;
    document.getElementById('bookingNumber').textContent = `Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²: ${isBoth ? "100933" : (resort.includes("ØªØ§Ù…Ø¨Ø§") ? "100117" : "100201")}`;
    document.getElementById('introText').innerHTML = `<p style="text-align:center">Ø£ÙØ¨Ø±Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†:<br>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„: ${resort} | Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ: ${name}</p>`;

    document.getElementById('bookingDetails').innerHTML = `
        <div style="margin-bottom:5px"><b>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</b> ${name}</div>
        <div style="margin-bottom:5px"><b>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†:</b> ${dep} Ø±ÙŠØ§Ù„ | <b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</b> ${rem} Ø±ÙŠØ§Ù„</div>
        <div style="margin-bottom:5px"><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${date}</div>
        <div style="margin-bottom:5px"><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${overnightText} | ${poolText}</div>
        <div class="${timeClass}" style="font-size:18px"><b>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø¬Ø²:</b> ${hours}</div>
    `;

    const list = document.getElementById('termsList');
    let terms = ["Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø³ØªØ±Ø¯","Ø§Ù„Ù…Ù†ØªØ¬Ø¹ ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø´Ø®ØµÙŠØ©","ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ø¯ÙŠØ© ÙŠØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙƒØ§ÙØ© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ","ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¯Ø®ÙŠÙ† Ø¯Ø§Ø®Ù„ ØºØ±Ù ÙˆØµØ§Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø¹ ğŸš­","ÙŠØ¬Ø¨ Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø­Ø§Ø±Ø³ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©","Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"];
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
list.innerHTML = terms.map(t => `<li>${t}</li>`).join('');

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
if (isWinter) {
    list.innerHTML += `<li class="text-red">ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥Ø´Ø¹Ø§Ù„ Ø§Ù„Ù†Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®ÙŠÙ…Ø© Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙŠÙ„</li>`;
}
if (isSummer) {
    list.innerHTML += `<li class="text-red">Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„ØµØ§Ø¨ÙˆÙ†ÙŠ Ù„Ù„Ø£Ø·ÙØ§Ù„ ÙˆÙŠØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£ÙŠ ØªÙ„ÙÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„ØµØ§Ø¨ÙˆÙ†ÙŠ</li>`;
}
    document.getElementById('contractFooter').textContent = `ØªØ­Ø±Ø± ÙÙŠ: ${new Date().toLocaleDateString('ar-SA')} â€” Ø¥Ø¯Ø§Ø±Ø© ${resort}`;
}

document.getElementById('saveAllBtn').onclick = function() {
    recordFinance(); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ§Ù‹
    
    const name = document.getElementById('customerName').value;
    const resort = document.getElementById('bookBothResorts').checked ? "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ†" : resortSelect.value;
    
    // 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ± Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
    const actionsDiv = document.querySelector('.actions');
    actionsDiv.style.visibility = 'hidden'; 

    html2canvas(document.getElementById('contract'), { 
        scale: 2,
        useCORS: true,
        logging: false
    }).then(canvas => {
        // 2. Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
        actionsDiv.style.visibility = 'visible';

        const link = document.createElement('a');
        link.download = `Ø¹Ù‚Ø¯_${name}.png`;
        link.href = canvas.toDataURL(); 
        link.click();
        
        // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        const info = resort.includes("ØªØ§Ù…Ø¨Ø§") ? {phone:"0567863628", loc:"https://maps.app.goo.gl/y3tLqg9a5Gq3VbA8A?g_st=ic"} : {phone:"0567863628", loc:"https://maps.app.goo.gl/tampa"};
        const msg = encodeURIComponent(`Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø± ${resort}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${document.getElementById('bookingDate').value}`);
        window.open(`https://wa.me/?text=${msg}`, '_blank');
    });
};

document.getElementById('calendarICSBtn').onclick = function() {
    recordFinance(); // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    
    const name = document.getElementById('customerName').value;
    const bookingDateVal = document.getElementById('bookingDate').value;
    
    if (!bookingDateVal) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ø£ÙˆÙ„Ø§Ù‹");

    // Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø³Ø§Ø¹Ø© 12:00 ØµØ¨Ø§Ø­Ø§Ù‹) ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ø§Ù„Ø³Ø§Ø¹Ø© 11:59 Ù…Ø³Ø§Ø¡Ù‹)
    const baseDate = new Date(bookingDateVal + "T00:00:00");
    const startDateString = formatDateTimeForGoogle(baseDate); 
    
    const endDate = new Date(baseDate.getTime());
    endDate.setHours(23, 59, 0); 
    const endDateString = formatDateTimeForGoogle(endDate); 

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø­Ø§Ù„Ø© "Ù…Ø´ØºÙˆÙ„" (Busy)
    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø¹Ù†ÙˆØ§Ù†
const isBoth = document.getElementById('bookBothResorts').checked;
const resortName = isBoth ? "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ†" : document.getElementById('resortSelect').value.replace("Ù…Ù†ØªØ¬Ø¹ ", "");
const statusOvernight = document.getElementById('overnight').checked ? "(Ù…Ø¨ÙŠØª)" : "(Ø¨Ø¯ÙˆÙ† Ù…Ø¨ÙŠØª)";
const statusPool = document.getElementById('noPool').checked ? "(Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¨Ø­)" : "(Ù…Ø³Ø¨Ø­)";
const statusWinter = document.getElementById('winterPeriod').checked ? "(ÙØªØ±Ø© Ø´ØªÙˆÙŠØ©)" : "";

// Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
const fullTitle = `${name}ØŒ ${document.getElementById('deposit').value}-${document.getElementById('remaining').value}ØŒ (${resortName})ØŒ ${statusOvernight} ${statusPool} ${statusWinter}`.trim();

const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: fullTitle, // Ø§Ù„Ø¹Ù†Ø§Ù„ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§
    dates: `${startDateString}/${endDateString}`,
    trp: '0', 
    sf: 'true',
    output: 'chrome'
});

    window.open(`https://www.google.com/calendar/render?${params.toString()}`, '_blank');
};

function renderReportTable() {
    updateYearSelector(); // ØªØ´ØºÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹
    
    let selector = document.getElementById('yearFilter');
    let selectedYear = selector.value;
    
    // ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (!selectedYear) {
        selectedYear = new Date().getFullYear().toString();
    }

    const reportTitle = document.getElementById('reportMainTitle');
    const tbody = document.getElementById('reportTableBody');
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    if(reportTitle) reportTitle.textContent = `Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø© ${selectedYear}`;
    
    tbody.innerHTML = '';
    const months = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const summary = {};
    let totalInc = 0, totalExp = 0, totalLoan = 0, totalOther = 0;

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    const filteredData = transactions.filter(t => 
        t.owner === currentPIN && 
        new Date(t.date).getFullYear().toString() === selectedYear
    );

    filteredData.forEach(t => {
        const m = new Date(t.date).getMonth();
        if (!summary[m]) summary[m] = { inc: 0, exp: 0, loan: 0, other: 0 };
        
        if (t.type === 'Ø¥ÙŠØ¬Ø§Ø±') summary[m].inc += t.amount;
        else if (t.type === 'Ù…ØµØ±ÙˆÙØ§Øª') summary[m].exp += t.amount;
        else if (t.type === 'Ø¬Ù…Ø¹ÙŠØ©') summary[m].loan += t.amount;
        else summary[m].other += t.amount;
    });

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø´Ù‡Ø±
    Object.keys(summary).sort((a, b) => a - b).forEach(m => {
        const s = summary[m];
        const net = s.inc - (s.exp + s.loan + s.other);
        const netClass = net >= 0 ? 'income' : 'expense';

        totalInc += s.inc; 
        totalExp += s.exp; 
        totalLoan += s.loan; 
        totalOther += s.other;

        tbody.innerHTML += `<tr>
            <td>${months[m]} ${selectedYear}</td>
            <td class="income">${s.inc}</td>
            <td class="expense">${s.exp}</td>
            <td>${s.loan}</td>
            <td>${s.other}</td>
            <td class="${netClass}"><b>${net}</b></td>
        </tr>`;
    });

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„
    if (Object.keys(summary).length > 0) {
        const totalNet = totalInc - (totalExp + totalLoan + totalOther);
        tbody.innerHTML += `
            <tr style="background: #eee; border-top: 2px solid #333;">
                <td style="font-weight: bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${selectedYear}</td>
                <td class="income" style="font-weight: bold;">${totalInc}</td>
                <td class="expense" style="font-weight: bold;">${totalExp}</td>
                <td style="font-weight: bold;">${totalLoan}</td>
                <td style="font-weight: bold;">${totalOther}</td>
                <td class="${totalNet >= 0 ? 'income' : 'expense'}" style="font-weight: bold; border-left: 2px solid #333;">${totalNet}</td>
            </tr>`;
    } else {
        tbody.innerHTML = '<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</td></tr>';
    }
}

function deleteTrans(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) { transactions = transactions.filter(t => t.id != id); saveSystem(); } }

function openTab(evt, tabId) {
    let contents = document.getElementsByClassName("tab-content");
    for (let c of contents) c.classList.remove("active");
    let btns = document.querySelectorAll(".tab-nav button");
    for (let b of btns) b.classList.remove("active");
    document.getElementById(tabId).classList.add("active");
    evt.currentTarget.classList.add("active");
}

async function loadSystem() {
    document.getElementById('transDate').valueAsDate = new Date();
    // Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Ù‚ÙˆÙ‚Ù„ Ø´ÙŠØª ÙÙˆØ± ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
    await pullFromCloud(); 
    renderDailyTable();
    renderReportTable();
}
// ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
function exportToExcel() {
    const table = document.getElementById("reportTable");
    let csv = [];
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„ØµÙÙˆÙ
    for (let i = 0; i < table.rows.length; i++) {
        let row = [], cols = table.rows[i].cells;
        for (let j = 0; j < cols.length; j++) {
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙÙˆØ§ØµÙ„ Ù‚Ø¯ ØªÙØ³Ø¯ ØªÙ†Ø³ÙŠÙ‚ CSV
            row.push(cols[j].innerText.replace(/,/g, ""));
        }
        csv.push(row.join(","));
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨ØªØ±Ù…ÙŠØ² UTF-8)
    const csvContent = "\uFEFF" + csv.join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ù…Ù†ØªØ¬Ø¹Ø§Øª_Ø§Ù„ Ø¯ÙˆØ§Ø³_${new Date().getFullYear()}.csv`);
    link.click();
}

// ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØµØ¯ÙŠØ± ÙƒØµÙˆØ±Ø© (PNG)
function exportToImage() {
    const reportTab = document.getElementById("reportTab");
    const actions = reportTab.querySelector('.actions');
    const tableWrapper = reportTab.querySelector('.table-wrapper');

    actions.style.display = 'none';

    // Ø­ÙØ¸ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const originalWrapperStyle = tableWrapper.style.cssText;
    const originalContainerStyle = reportTab.style.cssText;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„Ù„ØªØµÙˆÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„
    tableWrapper.style.overflow = 'visible';
    tableWrapper.style.width = 'max-content'; // Ø¬Ø¹Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© ØªØªØ³Ø¹ Ù„ÙƒØ§Ù…Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    reportTab.style.width = 'max-content';
    reportTab.style.maxWidth = 'none';

    html2canvas(reportTab, { 
        scale: 2,
        backgroundColor: "#fdf5e6",
        useCORS: true,
        // Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø´Ø§Ø´Ø©
        width: reportTab.scrollWidth,
        windowWidth: reportTab.scrollWidth 
    }).then(canvas => {
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        tableWrapper.style.cssText = originalWrapperStyle;
        reportTab.style.cssText = originalContainerStyle;
        actions.style.display = 'flex';

        const link = document.createElement('a');
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ù†ØªØ¬Ø¹Ø§Øª_Ø´Ø§Ù…Ù„_${new Date().toLocaleDateString()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });
}
</script>
</body>
</html>

