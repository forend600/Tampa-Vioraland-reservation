<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ù…Ù†ØªØ¬Ø¹Ø§Øª Ø§Ù„ Ø¯ÙˆØ§Ø³ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2980b9">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* (ØªØ¨Ù‚Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø· CSS ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) */
        *, *::before, *::after { box-sizing: border-box; }
        :root { --brand-blue: #2980b9; --brand-green: #27ae60; --brand-red: #e74c3c; --brand-gold: #f1c40f; }
        body { font-family: 'Times New Roman', Arial, Tahoma, sans-serif; direction: rtl; margin: 0; padding: 0; background: #fdf5e6; text-align: right; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .tab-nav { display: flex; background: var(--brand-blue); position: sticky; top: 0; z-index: 1000; }
        .tab-nav button { flex: 1; padding: 15px; border: none; background: none; color: white; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; font-size: 14px; }
        .tab-nav button.active { border-bottom: 3px solid #fff; background: rgba(255,255,255,0.1); }
        .tab-content { display: none; padding: 10px; }
        .tab-content.active { display: block; }
        .container { max-width: 800px; margin: 10px auto; padding: 20px; background: #fff; border-radius: 14px; border: 3px solid var(--brand-blue); }
        h1 { text-align: center; color: #2c3e50; font-size: 22px; margin-bottom: 5px; }
        .title-underline { width: 80px; height: 3px; background: var(--brand-blue); margin: 0 auto 15px; }
        form, .card { max-width: 520px; margin: 10px auto; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.07); }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; text-align: right; font-size: 16px; }
        .btn-primary { background: var(--brand-green); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; margin-top: 15px; font-weight: bold; font-size: 16px; }
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 15px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 13px; white-space: nowrap; }
        .income { color: var(--brand-green); font-weight: bold; }
        .expense { color: var(--brand-red); font-weight: bold; }
        #contract { display: none; margin-top: 20px; }
        @media print { .tab-nav, .actions, form, .card, #loginOverlay { display: none !important; } .container { border: none; } }
    </style>
</head>
<body>

<div id="loginOverlay">
    <h2>Ù…Ù†ØªØ¬Ø¹Ø§Øª Ø§Ù„ Ø¯ÙˆØ§Ø³</h2>
    <p>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ù‚ÙˆÙ‚Ù„</p>
    <div id="g_id_onload"
         data-client_id="809378312368-be35pci821otu0mdurik53imidefmvhj.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-shape="rectangular"></div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<nav class="tab-nav">
    <button class="active" onclick="openTab(event, 'reservationTab')">Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
    <button onclick="openTab(event, 'dailyTab')">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
    <button onclick="openTab(event, 'reportTab')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="logout()" style="background:var(--brand-red); flex:0.3; margin-right:5px; border-radius:5px;">Ø®Ø±ÙˆØ¬</button>
</nav>

<div id="reservationTab" class="tab-content active">
    <h1>Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø±</h1>
    <div class="title-underline"></div>
    <form id="bookingForm">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø¹:</label>
        <select id="resortSelect">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø¹</option>
            <option value="Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§">Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§</option>
            <option value="Ù…Ù†ØªØ¬Ø¹ ÙÙŠÙˆØ±Ø§Ù„Ø§Ù†Ø¯">Ù…Ù†ØªØ¬Ø¹ ÙÙŠÙˆØ±Ø§Ù„Ø§Ù†Ø¯</option>
        </select>
        <div class="options-row"><div class="option-block"><input type="checkbox" id="bookBothResorts"><label>Ø­Ø¬Ø² Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ† Ù…Ø¹Ø§Ù‹</label></div></div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
        <input type="text" id="customerName" required>
        <label>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†:</label>
        <input type="number" id="deposit" required>
        <label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
        <input type="number" id="remaining" required>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
        <input type="date" id="bookingDate" required>
        <div class="options-row">
            <div class="option-block"><input type="checkbox" id="overnight"><label>Ù…Ø¨ÙŠØª</label></div>
            <div class="option-block"><input type="checkbox" id="noPool"><label>Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¨Ø­</label></div>
            <div class="option-block"><input type="checkbox" id="winterPeriod"><label>ÙØªØ±Ø© Ø§Ù„Ø´ØªÙˆÙŠØ©</label></div>
        </div>
        <div id="tampaOptions" style="display:none; flex-direction: row; align-items: center; justify-content: flex-end; gap: 15px;">
            <span style="font-weight:bold;">Ø®Ø§Øµ Ø¨ØªØ§Ù…Ø¨Ø§:</span>
            <div class="option-block"><input type="checkbox" id="summer"><label for="summer">ØµÙŠÙ</label></div>
            <div class="option-block"><input type="checkbox" id="winter"><label for="winter">Ø´ØªØ§Ø¡</label></div>
        </div>
        <button type="submit" class="btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯</button>
    </form>

    <div id="contract" class="container">
        <h1 id="contractTitle"></h1>
        <div id="bookingNumber" class="booking-number"></div>
        <div id="introText"></div>
        <div id="bookingDetails"></div>
        <hr>
        <div class="terms">
            <h3>Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…:</h3>
            <ul id="termsList"></ul>
            <p style="text-align:center"><strong>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø±Ø¯ Ø¨ÙƒÙ„Ù…Ø© Ù…ÙˆØ§ÙÙ‚</strong></p>
        </div>
        <div id="contractFooter" class="contract-footer"></div>
        <div class="actions" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button id="saveAllBtn" class="btn-primary" style="background:var(--brand-green)">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ + Ø­ÙØ¸ Ù…Ø§Ù„ÙŠØ©</button>
            <button id="calendarICSBtn" class="btn-primary" style="background:var(--brand-blue)">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙ‚ÙˆÙŠÙ… + Ø­ÙØ¸ Ù…Ø§Ù„ÙŠØ©</button>
        </div>
    </div>
</div>

<div id="dailyTab" class="tab-content">
    <h1>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
    <div class="card">
        <h3>Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ©</h3>
        <input type="hidden" id="editId">
        <input type="date" id="transDate">
        <select id="transType">
            <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø± (Ø¯Ø®Ù„)</option>
            <option value="Ù…ØµØ±ÙˆÙØ§Øª">Ù…ØµØ±ÙˆÙØ§Øª</option>
            <option value="Ø¬Ù…Ø¹ÙŠØ©">Ø¬Ù…Ø¹ÙŠØ© / Ù‚Ø±ÙˆØ¶</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input type="number" id="transAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="transDesc" placeholder="Ø§Ù„ÙˆØµÙ (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ)">
        <button onclick="saveTransaction()" id="mainSaveBtn" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>

    <div class="card">
        <div class="filter-box">
            <input type="text" id="searchQuery" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." oninput="renderDailyTable()">
            <select id="filterType" onchange="renderDailyTable()">
                <option value="Ø§Ù„ÙƒÙ„">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
                <option value="Ù…ØµØ±ÙˆÙØ§Øª">Ù…ØµØ±ÙˆÙØ§Øª</option>
                <option value="Ø¬Ù…Ø¹ÙŠØ©">Ø¬Ù…Ø¹ÙŠØ© / Ù‚Ø±ÙˆØ¶</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="dailyTable">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="dailyTableBody"></tbody>
        </table>
    </div>
</div>

<div id="reportTab" class="tab-content">
    <h1 id="reportMainTitle">Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø© 2026</h1>
    <div class="title-underline"></div>
    <div class="card" style="max-width: 200px; margin-bottom: 20px;">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
        <select id="yearFilter" onchange="renderReportTable()"></select>
    </div>
    <div class="table-wrapper">
        <table id="reportTable">
            <thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø¯Ø®Ù„ (+)</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (-)</th><th>Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© (-)</th><th>Ø£Ø®Ø±Ù‰ (-)</th><th>Ø§Ù„ØµØ§ÙÙŠ</th></tr></thead>
            <tbody id="reportTableBody"></tbody>
        </table>
    </div>
    <div class="actions" style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="exportToExcel()" class="btn-primary" style="background:#1d6f42">ØªØµØ¯ÙŠØ± Excel</button>
        <button onclick="exportToImage()" class="btn-primary" style="background:#c0392b">ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© / PDF</button>
    </div>
</div>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
let currentUserEmail = localStorage.getItem('thalathat_user_session') || ""; 
let transactions = JSON.parse(localStorage.getItem('thalathat_v5_data')) || [];
let isCurrentSaved = false;
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyR-wiPwm-KwTFVq3zBTy8FH8NEVQyFWuRQrtrzDfNI9WRhPwStd_ITAhynDpQiIwIJ/exec";

// ÙÙƒ ØªØ´ÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
function parseJwt(token) {
    let base64Url = token.split('.')[1];
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(window.atob(base64));
}

function handleCredentialResponse(response) {
    const user = parseJwt(response.credential);
    currentUserEmail = user.email;
    localStorage.setItem('thalathat_user_session', currentUserEmail);
    document.getElementById('loginOverlay').style.display = 'none';
    loadSystem();
}

function logout() {
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        localStorage.removeItem('thalathat_user_session');
        location.reload();
    }
}

// Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
async function pushToCloud() {
    if (!currentUserEmail) return;
    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ userEmail: currentUserEmail, data: transactions })
        });
    } catch (e) { console.error("Ø®Ø·Ø£ Ù…Ø²Ø§Ù…Ù†Ø©"); }
}

async function pullFromCloud() {
    if (!currentUserEmail) return;
    try {
        const response = await fetch(`${SCRIPT_URL}?userEmail=${currentUserEmail}`);
        const cloudData = await response.json();
        if (Array.isArray(cloudData)) {
            transactions = cloudData;
            localStorage.setItem('thalathat_v5_data', JSON.stringify(transactions));
            renderDailyTable();
            renderReportTable();
        }
    } catch (e) { console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ©"); }
}

async function loadSystem() {
    if (currentUserEmail) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('transDate').valueAsDate = new Date();
        await pullFromCloud();
        renderDailyTable();
        renderReportTable();
    }
}

function saveSystem() {
    localStorage.setItem('thalathat_v5_data', JSON.stringify(transactions));
    renderDailyTable();
    renderReportTable();
    pushToCloud();
}

// Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
function renderDailyTable() {
    const tbody = document.getElementById('dailyTableBody');
    const query = (document.getElementById('searchQuery').value || "").toLowerCase();
    const typeFilter = document.getElementById('filterType').value;
    tbody.innerHTML = '';
    
    transactions.filter(t => t.owner === currentUserEmail)
        .filter(t => (typeFilter === "Ø§Ù„ÙƒÙ„" || t.type === typeFilter))
        .filter(t => (t.desc.toLowerCase().includes(query)))
        .sort((a,b) => new Date(b.date) - new Date(a.date))
        .forEach(t => {
            tbody.innerHTML += `<tr>
                <td>${t.date}</td>
                <td>${t.type}</td>
                <td>${t.desc}</td>
                <td class="${t.type === 'Ø¥ÙŠØ¬Ø§Ø±' ? 'income' : 'expense'}">${t.amount}</td>
                <td>
                    <span onclick="editTrans(${t.id})" style="cursor:pointer">âœï¸</span> 
                    <span onclick="deleteTrans(${t.id})" style="cursor:pointer">ğŸ—‘ï¸</span>
                </td>
            </tr>`;
        });
}

function saveTransaction() {
    const editId = document.getElementById('editId').value;
    const date = document.getElementById('transDate').value;
    const type = document.getElementById('transType').value;
    const amount = parseFloat(document.getElementById('transAmount').value);
    const desc = document.getElementById('transDesc').value;

    if(!date || isNaN(amount)) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    if (editId) {
        const idx = transactions.findIndex(t => t.id == editId);
        if (idx !== -1) transactions[idx] = { ...transactions[idx], date, type, amount, desc };
    } else {
        transactions.push({ id: Date.now(), date, type, amount, desc, owner: currentUserEmail });
    }
    saveSystem();
    resetFinanceForm();
}

function editTrans(id) {
    const t = transactions.find(item => item.id == id);
    if(t) {
        document.getElementById('editId').value = t.id;
        document.getElementById('transDate').value = t.date;
        document.getElementById('transType').value = t.type;
        document.getElementById('transAmount').value = t.amount;
        document.getElementById('transDesc').value = t.desc;
        const btn = document.getElementById('mainSaveBtn');
        btn.textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
        btn.style.background = "var(--brand-gold)";
    }
}

function resetFinanceForm() {
    document.getElementById('editId').value = "";
    document.getElementById('transAmount').value = "";
    document.getElementById('transDesc').value = "";
    document.getElementById('transDate').valueAsDate = new Date();
    const btn = document.getElementById('mainSaveBtn');
    btn.textContent = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
    btn.style.background = "var(--brand-green)";
}

// Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
function updateYearSelector() {
    const sel = document.getElementById('yearFilter');
    let years = transactions.map(t => new Date(t.date).getFullYear());
    years.push(new Date().getFullYear());
    const unique = [...new Set(years)].sort((a,b) => b-a);
    const current = sel.value || new Date().getFullYear().toString();
    sel.innerHTML = unique.map(y => `<option value="${y}">${y}</option>`).join('');
    sel.value = current;
}

function renderReportTable() {
    updateYearSelector();
    const year = document.getElementById('yearFilter').value;
    document.getElementById('reportMainTitle').textContent = `Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø© ${year}`;
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    
    const months = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const summary = {};
    let tInc=0, tExp=0, tLoan=0, tOth=0;

    transactions.filter(t => t.owner === currentUserEmail && new Date(t.date).getFullYear().toString() === year)
    .forEach(t => {
        const m = new Date(t.date).getMonth();
        if (!summary[m]) summary[m] = { inc:0, exp:0, loan:0, other:0 };
        if (t.type === 'Ø¥ÙŠØ¬Ø§Ø±') summary[m].inc += t.amount;
        else if (t.type === 'Ù…ØµØ±ÙˆÙØ§Øª') summary[m].exp += t.amount;
        else if (t.type === 'Ø¬Ù…Ø¹ÙŠØ©') summary[m].loan += t.amount;
        else summary[m].other += t.amount;
    });

    Object.keys(summary).sort((a,b) => a-b).forEach(m => {
        const s = summary[m];
        const net = s.inc - (s.exp + s.loan + s.other);
        tInc+=s.inc; tExp+=s.exp; tLoan+=s.loan; tOth+=s.other;
        tbody.innerHTML += `<tr><td>${months[m]}</td><td class="income">${s.inc}</td><td class="expense">${s.exp}</td><td>${s.loan}</td><td>${s.other}</td><td class="${net>=0?'income':'expense'}">${net}</td></tr>`;
    });
    if(tInc+tExp > 0) {
        tbody.innerHTML += `<tr style="background:#eee; font-weight:bold;"><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td class="income">${tInc}</td><td class="expense">${tExp}</td><td>${tLoan}</td><td>${tOth}</td><td>${tInc-(tExp+tLoan+tOth)}</td></tr>`;
    }
}

// Ø§Ù„Ø¹Ù‚ÙˆØ¯ ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ…
function recordFinance() {
    if(isCurrentSaved) return;
    const resort = document.getElementById('bookBothResorts').checked ? "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ†" : document.getElementById('resortSelect').value;
    const name = document.getElementById('customerName').value;
    const total = parseFloat(document.getElementById('deposit').value) + parseFloat(document.getElementById('remaining').value);
    const date = document.getElementById('bookingDate').value;
    if(!date || isNaN(total)) return;
    transactions.push({ id: Date.now(), date, type: 'Ø¥ÙŠØ¬Ø§Ø±', amount: total, desc: `Ø­Ø¬Ø² ${resort}: ${name}`, owner: currentUserEmail });
    isCurrentSaved = true;
    saveSystem();
}

function formatDateTimeForGoogle(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const da = String(d.getDate()).padStart(2, '0');
    return `${y}${m}${da}T000000/${y}${m}${da}T235959`;
}

document.getElementById('calendarICSBtn').onclick = function() {
    recordFinance();
    const name = document.getElementById('customerName').value;
    const date = document.getElementById('bookingDate').value;
    if(!date) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®Ø§Ù‹");
    const dates = formatDateTimeForGoogle(new Date(date));
    const title = encodeURIComponent(`${name} - Ø­Ø¬Ø² Ù…Ù†ØªØ¬Ø¹`);
    window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}`, '_blank');
};

document.getElementById('saveAllBtn').onclick = function() {
    recordFinance();
    html2canvas(document.getElementById('contract')).then(canvas => {
        const link = document.createElement('a');
        link.download = `Ø¹Ù‚Ø¯.png`;
        link.href = canvas.toDataURL();
        link.click();
        const msg = encodeURIComponent(`ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ`);
        window.open(`https://wa.me/?text=${msg}`, '_blank');
    });
};

function openTab(evt, tabId) {
    let contents = document.getElementsByClassName("tab-content");
    for (let c of contents) c.classList.remove("active");
    let btns = document.querySelectorAll(".tab-nav button");
    for (let b of btns) b.classList.remove("active");
    document.getElementById(tabId).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function deleteTrans(id) { if(confirm("Ø­Ø°ÙØŸ")) { transactions = transactions.filter(t => t.id != id); saveSystem(); } }

window.onload = loadSystem;
</script>
</body>
</html>
