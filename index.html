<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ù…Ù†ØªØ¬Ø¹Ø§Øª Ø§Ù„ Ø¯ÙˆØ§Ø³ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2980b9">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* (ØªØ¨Ù‚Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø· CSS ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) */
        *, *::before, *::after { box-sizing: border-box; }
        :root { --brand-blue: #2980b9; --brand-green: #27ae60; --brand-red: #e74c3c; --brand-gold: #f1c40f; }
        body { font-family: 'Times New Roman', Arial, Tahoma, sans-serif; direction: rtl; margin: 0; padding: 0; background: #fdf5e6; text-align: right; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .tab-nav { display: flex; background: var(--brand-blue); position: sticky; top: 0; z-index: 1000; }
        .tab-nav button { flex: 1; padding: 15px; border: none; background: none; color: white; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; font-size: 14px; }
        .tab-nav button.active { border-bottom: 3px solid #fff; background: rgba(255,255,255,0.1); }
        .tab-content { display: none; padding: 10px; }
        .tab-content.active { display: block; }
        .container { max-width: 800px; margin: 10px auto; padding: 20px; background: #fff; border-radius: 14px; border: 3px solid var(--brand-blue); }
        h1 { text-align: center; color: #2c3e50; font-size: 22px; margin-bottom: 5px; }
        .title-underline { width: 80px; height: 3px; background: var(--brand-blue); margin: 0 auto 15px; }
        form, .card { max-width: 520px; margin: 10px auto; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.07); }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; text-align: right; font-size: 16px; }
        .btn-primary { background: var(--brand-green); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; margin-top: 15px; font-weight: bold; font-size: 16px; }
        .table-wrapper { 
    width: 100%; 
    overflow-x: auto; 
    margin-top: 15px; 
    -webkit-overflow-scrolling: touch; 
}

table { 
    width: 100%; 
    border-collapse: collapse; 
    background: white; 
    table-layout: auto; /* ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ†ÙƒÙ…Ø´ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
}

th, td { 
    border: 1px solid #eee; 
    padding: 6px 4px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ù Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© */
    text-align: center; 
    font-size: 12px; /* Ø®Ø· Ø£ØµØºØ± Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    white-space: nowrap; 
}

/* Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø£Ø®ÙŠØ± */
th:last-child, td:last-child {
    background: #f9f9f9;
    font-weight: bold;
    border-right: 2px solid #ddd;
}

@media (max-width: 600px) {
    th, td { font-size: 11px; padding: 4px 2px; }
    h1 { font-size: 18px; }
}
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 13px; white-space: nowrap; }
        .income { color: var(--brand-green); font-weight: bold; }
        .expense { color: var(--brand-red); font-weight: bold; }
        #contract { display: none; margin-top: 20px; }
        @media print { .tab-nav, .actions, form, .card, #loginOverlay { display: none !important; } .container { border: none; } }
        .options-row { 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: flex-start; 
    gap: 15px; 
    margin-top: 10px; 
    direction: rtl; 
}
.option-block { display: flex; align-items: center; gap: 5px; font-size: 14px; }
.option-block input { width: auto; margin: 0; }
.text-red { color: var(--brand-red); font-weight: bold; }
.text-green { color: var(--brand-green); font-weight: bold; }
        .text-blue { color: #2980b9; font-weight: bold; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <h2>Ù…Ù†ØªØ¬Ø¹Ø§Øª Ø§Ù„ Ø¯ÙˆØ§Ø³</h2>
    <p>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ù‚ÙˆÙ‚Ù„</p>
    <div id="g_id_onload"
         data-client_id="809378312368-be35pci821otu0mdurik53imidefmvhj.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-shape="rectangular"></div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<nav class="tab-nav">
    <button class="active" onclick="openTab(event, 'reservationTab')">Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
    <button onclick="openTab(event, 'dailyTab')">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
    <button onclick="openTab(event, 'reportTab')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="logout()" style="background:var(--brand-red); flex:0.3; margin-right:5px; border-radius:5px;">Ø®Ø±ÙˆØ¬</button>
</nav>

<div id="reservationTab" class="tab-content active">
    <h1>Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø±</h1>
    <div class="title-underline"></div>
    <form id="bookingForm">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø¹:</label>
        <select id="resortSelect">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø¹</option>
            <option value="Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§">Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§</option>
            <option value="Ù…Ù†ØªØ¬Ø¹ ÙÙŠÙˆØ±Ø§Ù„Ø§Ù†Ø¯">Ù…Ù†ØªØ¬Ø¹ ÙÙŠÙˆØ±Ø§Ù„Ø§Ù†Ø¯</option>
        </select>
        <div class="options-row"><div class="option-block"><input type="checkbox" id="bookBothResorts"><label>Ø­Ø¬Ø² Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ† Ù…Ø¹Ø§Ù‹</label></div></div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</label>
        <input type="text" id="customerName" required>
        <label>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†:</label>
        <input type="number" id="deposit" required>
        <label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
        <input type="number" id="remaining" required>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²:</label>
        <input type="date" id="bookingDate" required>
        <div class="options-row">
            <div class="option-block"><input type="checkbox" id="overnight"><label>Ù…Ø¨ÙŠØª</label></div>
            <div class="option-block"><input type="checkbox" id="noPool"><label>Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¨Ø­</label></div>
            <div class="option-block"><input type="checkbox" id="winterPeriod"><label>ÙØªØ±Ø© Ø§Ù„Ø´ØªÙˆÙŠØ©</label></div>
        </div>
        <div id="tampaOptions" style="display:none; flex-direction: row; align-items: center; justify-content: flex-end; gap: 15px;">
            <span style="font-weight:bold;">Ø®Ø§Øµ Ø¨ØªØ§Ù…Ø¨Ø§:</span>
            <div class="option-block"><input type="checkbox" id="summer"><label for="summer">ØµÙŠÙ</label></div>
            <div class="option-block"><input type="checkbox" id="winter"><label for="winter">Ø´ØªØ§Ø¡</label></div>
        </div>
        <button type="submit" class="btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯</button>
    </form>

    <div id="contract" class="container">
        <h1 id="contractTitle"></h1>
        <div id="bookingNumber" class="booking-number"></div>
        <div id="introText"></div>
        <div id="bookingDetails"></div>
        <hr>
        <div class="terms">
            <h3>Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…:</h3>
            <ul id="termsList"></ul>
            <p style="text-align:center"><strong>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø±Ø¯ Ø¨ÙƒÙ„Ù…Ø© Ù…ÙˆØ§ÙÙ‚</strong></p>
        </div>
        <div id="contractFooter" class="contract-footer"></div>
        <div class="actions" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button id="saveAllBtn" class="btn-primary" style="background:var(--brand-green)">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ + Ø­ÙØ¸ Ù…Ø§Ù„ÙŠØ©</button>
            <button id="calendarICSBtn" class="btn-primary" style="background:var(--brand-blue)">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªÙ‚ÙˆÙŠÙ… + Ø­ÙØ¸ Ù…Ø§Ù„ÙŠØ©</button>
        </div>
    </div>
</div>

<div id="dailyTab" class="tab-content">
    <h1>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
    <div class="card">
        <h3>Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ©</h3>
        <input type="hidden" id="editId">
        <input type="date" id="transDate">
        <select id="transType">
            <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø± (Ø¯Ø®Ù„)</option>
            <option value="Ù…ØµØ±ÙˆÙØ§Øª">Ù…ØµØ±ÙˆÙØ§Øª</option>
            <option value="Ø¬Ù…Ø¹ÙŠØ©">Ø¬Ù…Ø¹ÙŠØ© / Ù‚Ø±ÙˆØ¶</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
        <input type="number" id="transAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="transDesc" placeholder="Ø§Ù„ÙˆØµÙ (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ)">
        <button onclick="saveTransaction()" id="mainSaveBtn" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>

    <div class="card">
        <div class="filter-box">
            <input type="text" id="searchQuery" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." oninput="renderDailyTable()">
            <select id="filterType" onchange="renderDailyTable()">
                <option value="Ø§Ù„ÙƒÙ„">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
                <option value="Ù…ØµØ±ÙˆÙØ§Øª">Ù…ØµØ±ÙˆÙØ§Øª</option>
                <option value="Ø¬Ù…Ø¹ÙŠØ©">Ø¬Ù…Ø¹ÙŠØ© / Ù‚Ø±ÙˆØ¶</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="dailyTable">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="dailyTableBody"></tbody>
        </table>
    </div>
</div>

<div id="reportTab" class="tab-content">
    <h1 id="reportMainTitle">Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø© 2026</h1>
    <div class="title-underline"></div>
    <div class="card" style="max-width: 200px; margin-bottom: 20px;">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
        <select id="yearFilter" onchange="renderReportTable()"></select>
    </div>
    <div class="table-wrapper">
        <table id="reportTable">
            <thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø¯Ø®Ù„ (+)</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (-)</th><th>Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© (-)</th><th>Ø£Ø®Ø±Ù‰ (-)</th><th>Ø§Ù„ØµØ§ÙÙŠ</th></tr></thead>
            <tbody id="reportTableBody"></tbody>
        </table>
    </div>
    <div class="actions" style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="exportToExcel()" class="btn-primary" style="background:#1d6f42">ØªØµØ¯ÙŠØ± Excel</button>
        <button onclick="exportToImage()" class="btn-primary" style="background:#c0392b">ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© / PDF</button>
    </div>
</div>

<script>
// 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
let currentUserEmail = localStorage.getItem('thalathat_user_session') || ""; 
let transactions = JSON.parse(localStorage.getItem('thalathat_v5_data')) || [];
let isCurrentSaved = false;
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyR-wiPwm-KwTFVq3zBTy8FH8NEVQyFWuRQrtrzDfNI9WRhPwStd_ITAhynDpQiIwIJ/exec";

// ÙÙƒ ØªØ´ÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
function parseJwt(token) {
    let base64Url = token.split('.')[1];
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(window.atob(base64));
}

function handleCredentialResponse(response) {
    const user = parseJwt(response.credential);
    currentUserEmail = user.email;
    localStorage.setItem('thalathat_user_session', currentUserEmail);
    document.getElementById('loginOverlay').style.display = 'none';
    loadSystem();
}

function logout() {
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        localStorage.removeItem('thalathat_user_session');
        localStorage.removeItem('thalathat_v5_data');
        location.reload();
    }
}

// Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
async function pushToCloud() {
    if (!currentUserEmail) return;
    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ userEmail: currentUserEmail, data: transactions })
        });
    } catch (e) { console.error("Ø®Ø·Ø£ Ù…Ø²Ø§Ù…Ù†Ø©"); }
}

async function pullFromCloud() {
    if (!currentUserEmail) return;
    try {
        const response = await fetch(`${SCRIPT_URL}?userEmail=${currentUserEmail}`);
        const cloudData = await response.json();
        if (Array.isArray(cloudData)) {
            transactions = cloudData;
            localStorage.setItem('thalathat_v5_data', JSON.stringify(transactions));
            renderDailyTable();
            renderReportTable();
        }
    } catch (e) { console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ©"); }
}

async function loadSystem() {
    if (currentUserEmail) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('transDate').valueAsDate = new Date();
document.getElementById('bookingDate').valueAsDate = new Date();
        await pullFromCloud();
        renderDailyTable();
        renderReportTable();
    }
}

function saveSystem() {
    localStorage.setItem('thalathat_v5_data', JSON.stringify(transactions));
    renderDailyTable();
    renderReportTable();
    pushToCloud();
}

// 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„Ø­Ø°Ù
function openTab(evt, tabId) {
    let contents = document.getElementsByClassName("tab-content");
    for (let c of contents) c.classList.remove("active");
    let btns = document.querySelectorAll(".tab-nav button");
    for (let b of btns) b.classList.remove("active");
    document.getElementById(tabId).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function deleteTrans(id) {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) {
        transactions = transactions.filter(t => t.id != id);
        saveSystem();
    }
}

// 3. Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
function renderDailyTable() {
    const tbody = document.getElementById('dailyTableBody');
    const query = (document.getElementById('searchQuery').value || "").toLowerCase();
    const typeFilter = document.getElementById('filterType').value;
    tbody.innerHTML = '';
    
    transactions.filter(t => t.owner === currentUserEmail)
        .filter(t => (typeFilter === "Ø§Ù„ÙƒÙ„" || t.type === typeFilter))
        .filter(t => (t.desc.toLowerCase().includes(query)))
        .sort((a,b) => new Date(b.date) - new Date(a.date))
        .forEach(t => {
            tbody.innerHTML += `<tr>
                <td>${t.date}</td>
                <td>${t.type}</td>
                <td>${t.desc}</td>
                <td class="${t.type === 'Ø¥ÙŠØ¬Ø§Ø±' ? 'income' : 'expense'}">${t.amount}</td>
                <td>
                    <span onclick="editTrans(${t.id})" style="cursor:pointer">âœï¸</span> 
                    <span onclick="deleteTrans(${t.id})" style="cursor:pointer">ğŸ—‘ï¸</span>
                </td>
            </tr>`;
        });
}

function saveTransaction() {
    const editId = document.getElementById('editId').value;
    const date = document.getElementById('transDate').value;
    const type = document.getElementById('transType').value;
    const amount = parseFloat(document.getElementById('transAmount').value);
    const desc = document.getElementById('transDesc').value;

    if(!date || isNaN(amount)) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    if (editId) {
        const idx = transactions.findIndex(t => t.id == editId);
        if (idx !== -1) transactions[idx] = { ...transactions[idx], date, type, amount, desc };
    } else {
        transactions.push({ id: Date.now(), date, type, amount, desc, owner: currentUserEmail });
    }
    saveSystem();
    resetFinanceForm();
}

function editTrans(id) {
    const t = transactions.find(item => item.id == id);
    if(t) {
        document.getElementById('editId').value = t.id;
        document.getElementById('transDate').value = t.date;
        document.getElementById('transType').value = t.type;
        document.getElementById('transAmount').value = t.amount;
        document.getElementById('transDesc').value = t.desc;
        const btn = document.getElementById('mainSaveBtn');
        btn.textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
        btn.style.background = "var(--brand-gold)";
    }
}

function resetFinanceForm() {
    document.getElementById('editId').value = "";
    document.getElementById('transAmount').value = "";
    document.getElementById('transDesc').value = "";
    document.getElementById('transDate').valueAsDate = new Date();
    const btn = document.getElementById('mainSaveBtn');
    btn.textContent = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
    btn.style.background = "var(--brand-green)";
}

function updateYearSelector() {
    const sel = document.getElementById('yearFilter');
    let years = transactions.map(t => new Date(t.date).getFullYear());
    years.push(new Date().getFullYear());
    const unique = [...new Set(years)].sort((a,b) => b-a);
    const current = sel.value || new Date().getFullYear().toString();
    sel.innerHTML = unique.map(y => `<option value="${y}">${y}</option>`).join('');
    sel.value = current;
}

function renderReportTable() {
    updateYearSelector();
    const year = document.getElementById('yearFilter').value;
    document.getElementById('reportMainTitle').textContent = `Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø© ${year}`;
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    const months = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const summary = {};
    let tInc=0, tExp=0, tLoan=0, tOth=0;

    transactions.filter(t => t.owner === currentUserEmail && new Date(t.date).getFullYear().toString() === year)
    .forEach(t => {
        const m = new Date(t.date).getMonth();
        if (!summary[m]) summary[m] = { inc:0, exp:0, loan:0, other:0 };
        if (t.type === 'Ø¥ÙŠØ¬Ø§Ø±') summary[m].inc += t.amount;
        else if (t.type === 'Ù…ØµØ±ÙˆÙØ§Øª') summary[m].exp += t.amount;
        else if (t.type === 'Ø¬Ù…Ø¹ÙŠØ©') summary[m].loan += t.amount;
        else summary[m].other += t.amount;
    });

    Object.keys(summary).sort((a,b) => a-b).forEach(m => {
        const s = summary[m];
        const net = s.inc - (s.exp + s.loan + s.other);
        tInc+=s.inc; tExp+=s.exp; tLoan+=s.loan; tOth+=s.other;
        tbody.innerHTML += `<tr><td>${months[m]}</td><td class="income">${s.inc}</td><td class="expense">${s.exp}</td><td>${s.loan}</td><td>${s.other}</td><td class="${net>=0?'income':'expense'}">${net}</td></tr>`;
    });
    if(tInc+tExp > 0) {
        tbody.innerHTML += `<tr style="background:#eee; font-weight:bold;"><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td class="income">${tInc}</td><td class="expense">${tExp}</td><td>${tLoan}</td><td>${tOth}</td><td>${tInc-(tExp+tLoan+tOth)}</td></tr>`;
    }
}

// 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ù‚ÙˆØ¯
document.getElementById('resortSelect').addEventListener('change', function() {
    const tampaDiv = document.getElementById('tampaOptions');
    const isTampa = (this.value === 'Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§' || document.getElementById('bookBothResorts').checked);
    if(tampaDiv) tampaDiv.style.display = isTampa ? 'flex' : 'none';
});

document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    e.stopPropagation();
    isCurrentSaved = false; 
    showContract(); 
    document.getElementById('contract').scrollIntoView({ behavior: 'smooth' });
});

function showContract() {
    const resort = document.getElementById('bookBothResorts').checked ? "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ†" : document.getElementById('resortSelect').value;
    const name = document.getElementById('customerName').value;
    const dep = document.getElementById('deposit').value;
    const rem = document.getElementById('remaining').value;
    const date = document.getElementById('bookingDate').value;
    
    const isOvernight = document.getElementById('overnight').checked;
    const isNoPool = document.getElementById('noPool').checked;
    const isWinterPeriod = document.getElementById('winterPeriod').checked;
    const isTampaSummer = document.getElementById('summer').checked;
    const isTampaWinter = document.getElementById('winter').checked;

    // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
    let statusText = "";
    let statusClass = "";
    
    if (!isOvernight && !isNoPool) {
        statusText = "Ø¨Ø¯ÙˆÙ† Ù…Ø¨ÙŠØª + ÙŠØ´Ù…Ù„ Ù…Ø³Ø¨Ø­";
        statusClass = "text-green";
    } else {
        statusText = (isOvernight ? "ÙŠØ´Ù…Ù„ Ù…Ø¨ÙŠØª " : "Ø¨Ø¯ÙˆÙ† Ù…Ø¨ÙŠØª ") + (isNoPool ? "+ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¨Ø­" : "+ ÙŠØ´Ù…Ù„ Ù…Ø³Ø¨Ø­");
        statusClass = "text-red";
    }

    // 2. Ù…Ù†Ø·Ù‚ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
    let hoursText = "";
    let hoursClass = "";

    if (isWinterPeriod) {
        if (isOvernight) {
            hoursText = "Ù…Ù† Ù¢ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¡Ù  ØµØ¨Ø§Ø­Ø§Ù‹";
            hoursClass = "text-red";
        } else {
            hoursText = "Ù…Ù† Ù¢ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¢ ØµØ¨Ø§Ø­Ø§Ù‹";
            hoursClass = "text-blue";
        }
    } else {
        if (isOvernight) {
            hoursText = "Ù…Ù† Ù£ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¡Ù¡ ØµØ¨Ø§Ø­Ø§Ù‹";
            hoursClass = "text-red";
        } else {
            hoursText = "Ù…Ù† Ù£ Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ Ù¦ ØµØ¨Ø§Ø­Ø§Ù‹";
            hoursClass = "text-green";
        }
    }

    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯
    document.getElementById('contract').style.display = "block";
    document.getElementById('contractTitle').textContent = `Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø± ${resort}`;
    document.getElementById('bookingNumber').textContent = `Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²: ${Date.now().toString().slice(-6)}`;
    
    document.getElementById('bookingDetails').innerHTML = `
        <div style="line-height:2; font-size:16px;">
            <b>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</b> ${name}<br>
            <b>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†:</b> ${dep} Ø±ÙŠØ§Ù„ | <b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</b> ${rem} Ø±ÙŠØ§Ù„<br>
            <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${date}<br>
            <b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> <span class="${statusClass}">${statusText}</span><br>
            <b>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø¬Ø²:</b> <span class="${hoursClass}">${hoursText}</span>
        </div>
    `;

    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… (Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ø®Ø§ØµØ©)
    const list = document.getElementById('termsList');
    let generalTerms = [
        "Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø³ØªØ±Ø¯",
        "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ ØºÙŠØ± Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø´Ø®ØµÙŠØ©",
        "ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ø¯ÙŠØ© ÙŠØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙƒØ§ÙØ© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ",
        "ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¯Ø®ÙŠÙ† Ø¯Ø§Ø®Ù„ ØºØ±Ù ÙˆØµØ§Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø¹",
        "ÙŠØ¬Ø¨ Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø­Ø§Ø±Ø³ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©",
        "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"
    ];
    
    // Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ø§Ù„Ø£Ø³ÙˆØ¯
    let termsHtml = generalTerms.map(t => `<li style="color:black;">${t}</li>`).join('');
    
    // Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù…Ù†ØªØ¬Ø¹ ØªØ§Ù…Ø¨Ø§
    if (resort.includes("ØªØ§Ù…Ø¨Ø§") || document.getElementById('bookBothResorts').checked) {
        if (isTampaSummer) {
            termsHtml += `<li class="text-red">Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„ØµØ§Ø¨ÙˆÙ†ÙŠ Ù„Ù„Ø£Ø·ÙØ§Ù„ ÙˆÙŠØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£ÙŠ ØªÙ„ÙÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„ØµØ§Ø¨ÙˆÙ†ÙŠ</li>`;
        }
        if (isTampaWinter) {
            termsHtml += `<li class="text-red">ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥Ø´Ø¹Ø§Ù„ Ø§Ù„Ù†Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®ÙŠÙ…Ø© Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙŠÙ„</li>`;
        }
    }
    
    list.innerHTML = termsHtml;
    document.getElementById('contractFooter').textContent = `Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø¹Ø§Øª Ø¢Ù„ Ø¯ÙˆØ§Ø³ | ØªØ­Ø±Ø± Ø¨ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}`;
    document.getElementById('contract').scrollIntoView({ behavior: 'smooth' });
}

function recordFinance() {
    if(isCurrentSaved || !currentUserEmail) return;
    const resort = document.getElementById('bookBothResorts').checked ? "Ø§Ù„Ù…Ù†ØªØ¬Ø¹ÙŠÙ†" : document.getElementById('resortSelect').value;
    const name = document.getElementById('customerName').value;
    const total = parseFloat(document.getElementById('deposit').value) + parseFloat(document.getElementById('remaining').value);
    const date = document.getElementById('bookingDate').value;
    transactions.push({ id: Date.now(), date: date, type: 'Ø¥ÙŠØ¬Ø§Ø±', amount: total, desc: `Ø­Ø¬Ø² ${resort}: ${name}`, owner: currentUserEmail });
    isCurrentSaved = true;
    saveSystem();
}

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù‚Ø¯
document.getElementById('saveAllBtn').onclick = function() {
    recordFinance();
    html2canvas(document.getElementById('contract')).then(canvas => {
        const link = document.createElement('a');
        link.download = `Ø¹Ù‚Ø¯_${document.getElementById('customerName').value}.png`;
        link.href = canvas.toDataURL();
        link.click();
        window.open(`https://wa.me/?text=${encodeURIComponent('ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Ù…Ù†ØªØ¬Ø¹Ø§Øª Ø§Ù„ Ø¯ÙˆØ§Ø³')}`, '_blank');
    });
};

document.getElementById('calendarICSBtn').onclick = function() {
    recordFinance();
    const date = document.getElementById('bookingDate').value.replace(/-/g, '');
    const title = encodeURIComponent(`Ø­Ø¬Ø² ${document.getElementById('customerName').value}`);
    window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${date}/${date}`, '_blank');
};

// Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
window.onload = loadSystem;
    // 1. ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± Excel (CSV) Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØ§Ù„Ø¬ÙˆØ§Ù„
function exportToExcel() {
    const table = document.getElementById("reportTable");
    if (!table || table.rows.length <= 1) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");

    let csv = [];
    for (let i = 0; i < table.rows.length; i++) {
        let row = [], cols = table.rows[i].cells;
        for (let j = 0; j < cols.length; j++) {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙÙˆØ§ØµÙ„ ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
            let data = cols[j].innerText.replace(/,/g, "").trim();
            row.push(data);
        }
        csv.push(row.join(","));
    }

    // Ø¥Ø¶Ø§ÙØ© BOM Ù„Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Ø¥ÙƒØ³Ù„
    const csvContent = "\uFEFF" + csv.join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    
    link.setAttribute("href", url);
    link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ù†ØªØ¬Ø¹_${new Date().getFullYear()}.csv`);
    document.body.appendChild(link); // Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„
    link.click();
    document.body.removeChild(link);
}

// 2. ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø© (PNG) Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ
function exportToImage() {
    const reportArea = document.getElementById("reportTab");
    const actions = reportArea.querySelector('.actions');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ÙƒÙŠ Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
    if (actions) actions.style.visibility = 'hidden';

    html2canvas(reportArea, { 
        scale: 2, // Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
        backgroundColor: "#fdf5e6",
        useCORS: true,
        width: reportArea.scrollWidth,
        windowWidth: reportArea.scrollWidth
    }).then(canvas => {
        if (actions) actions.style.visibility = 'visible';

        const link = document.createElement('a');
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª_Ø§Ù„Ø³Ù†ÙˆÙŠ.png`;
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }).catch(err => {
        if (actions) actions.style.visibility = 'visible';
        alert("ÙØ´Ù„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©Ø› Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ ÙƒØ±ÙˆÙ…");
    });
}
</script>
</body>
</html>



